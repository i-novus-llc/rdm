<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="201904180804-RDM-456_1" author="arahmatullin" dbms="postgresql">
        <comment>Исключение time zone из timestamptz-полей таблиц схемы data</comment>
        <sql splitStatements="false">
            <![CDATA[
do
$$

declare
    r record;

begin
    for r in
        select l_c.*
          from information_schema.tables as l_t
         inner join information_schema.columns as l_c
            on l_c.table_name = l_t.table_name
         where l_t.table_type = 'BASE TABLE'
           and l_c.data_type = 'timestamp with time zone'
           and l_t.table_catalog = 'rdm'
           and l_t.table_schema = 'data'
           and l_c.column_name in ('SYS_PUBLISHTIME', 'SYS_CLOSETIME')
    loop
        execute 'alter table ' ||
                quote_ident(r.table_schema) || '.' ||
                quote_ident(r.table_name) ||
                ' alter column ' ||
                quote_ident(r.column_name) ||
                ' type timestamp without time zone';
    end loop;
end;

$$ language plpgsql;
            ]]>
        </sql>
    </changeSet>

</databaseChangeLog>