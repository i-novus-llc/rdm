<?xml version='1.0' encoding='UTF-8'?>
<simple-page xmlns="http://n2oapp.net/framework/config/schema/page-2.0" name="Структура">
    <form default-values-query-id="versionDefault" query-id="attribute" object-id="attribute">
        <fields>
            <input-text id="code" label="Код" required="true">
                <dependencies>
                    <enabling>typeof id == 'undefined'</enabling>
                </dependencies>
            </input-text>

            <input-text id="name" label="Наименование" required="true"/>

            <select id="attrType" label="Тип" required="true" label-field-id="name">
                <options>
                    <option id="STRING" name="Строковый"/>
                    <option id="INTEGER" name="Целочисленный"/>
                    <option id="FLOAT" name="Дробный"/>
                    <option id="DATE" name="Дата"/>
                    <option id="BOOLEAN" name="Логический"/>
                    <option id="REFERENCE" name="Ссылочный"/>
                </options>
            </select>

            <input-select id="referenceRefBook" label="Выбор справочника"
                          query-id="refBook" label-field-id="displayCode">
                <dependencies>
                    <visibility on="attrType">
                        attrType.id == 'REFERENCE'
                    </visibility>
                </dependencies>
                <pre-filters>
                    <eq field-id="hasPublishedVersion" value="true" />
                    <eq field-id="excludeByVersionId" value="{versionId}"/>
                </pre-filters>
                <validations>
                    <condition id="hasRefBook" severity="danger"
                               message="Справочник не выбран">
                        referenceRefBook != null
                    </condition>
                    <condition id="hasPrimaryAttribute" severity="danger"
                               message="У справочника нет первичного ключа">
                        referenceRefBook.hasPrimaryAttribute
                    </condition>
                </validations>
            </input-select>

            <!-- NB: После NNO-1629 сделать скрытие на основе toolbar\button\set-value\displayType\return 1|2; -->
            
            <input-select id="displayAttribute" label="Отображаемый атрибут"
                          query-id="attribute" label-field-id="name">
                <dependencies>
                    <visibility on="attrType,referenceRefBook">
                        (attrType.id == 'REFERENCE' &amp;&amp; referenceRefBook != null)
                    </visibility>
                </dependencies>
                <pre-filters>
                    <eq field-id="versionId" value="{referenceRefBook.version.id}" />
                </pre-filters>
                <validations>
                    <condition id="hasAttribute" severity="danger"
                               message="Атрибут не выбран">
                        displayAttribute != null
                    </condition>
                </validations>
            </input-select>

            <input-text id="displayExpression" label="Отображаемое поле">
                <dependencies>
                    <visibility on="attrType,referenceRefBook">
                        (attrType.id == 'REFERENCE' &amp;&amp; referenceRefBook != null)
                    </visibility>
                    <set-value on="displayAttribute">
                        if (displayAttribute.codeExpression != null)
                            return displayAttribute.codeExpression;
                    </set-value>
                </dependencies>
                <validations>
                    <condition id="hasExpression" severity="danger"
                               message="Поле не заполнено">
                        displayExpression != null
                    </condition>
                </validations>
            </input-text>

            <checkbox id="isPrimary" label="Первичный ключ">
                <dependencies>
                    <enabling on="attrType">
                        (attrType != null &amp;&amp; attrType.id != 'BOOLEAN')
                    </enabling>
                </dependencies>
            </checkbox>

            <text-area id="description" label="Описание" rows="2"/>

            <!-- Пользовательские проверки -->

            <checkbox id="required" label="Обязательный атрибут">
                <dependencies>
                    <visibility on="attrType,isPrimary">
                        (attrType != null &amp;&amp; attrType.id != 'BOOLEAN' &amp;&amp; !isPrimary)
                    </visibility>
                    <set-value on="isPrimary">
                        if (isPrimary) return false; else return;
                    </set-value>
                </dependencies>
            </checkbox>

            <checkbox id="unique" label="Уникальный атрибут">
                <dependencies>
                    <visibility on="attrType,isPrimary">
                        (attrType != null &amp;&amp; attrType.id != 'BOOLEAN' &amp;&amp; !isPrimary)
                    </visibility>
                    <set-value on="isPrimary">
                        if (isPrimary) return false; else return;
                    </set-value>
                </dependencies>
            </checkbox>

            <input-text id="plainSize" domain="integer" label="Максимальная длина" min="1">
                <dependencies>
                    <visibility on="attrType">
                        attrType.id == 'STRING' || attrType.id == 'INTEGER'
                    </visibility>
                </dependencies>
            </input-text>
            <row>
                <input-text id="intPartSize" domain="integer" label="Максимальная длина целой части" min="1">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'FLOAT'
                        </visibility>
                    </dependencies>
                </input-text>
                <input-text id="fracPartSize" domain="integer" label="Максимальная длина дробной части" min="1">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'FLOAT'
                        </visibility>
                    </dependencies>
                </input-text>
            </row>

            <row>
                <input-text id="minInteger" domain="integer" label="Минимальное значение">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'INTEGER'
                        </visibility>
                    </dependencies>
                </input-text>
                <input-text id="maxInteger" domain="integer" label="Максимальное значение">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'INTEGER'
                        </visibility>
                    </dependencies>
                </input-text>
            </row>
            <row>
                <input-text id="minFloat" domain="numeric" label="Минимальное значение">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'FLOAT'
                        </visibility>
                    </dependencies>
                </input-text>
                <input-text id="maxFloat" domain="numeric" label="Максимальное значение">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'FLOAT'
                        </visibility>
                    </dependencies>
                </input-text>
            </row>
            <row>
                <date-interval id="dateInterval" label="Интервал значений">
                    <dependencies>
                        <visibility on="attrType">
                            attrType.id == 'DATE'
                        </visibility>
                    </dependencies>
                </date-interval>
            </row>
            <input-text id="regExp" domain="string" label="Регулярное выражение">
                <dependencies>
                    <visibility on="attrType">
                        attrType.id == 'STRING'
                    </visibility>
                </dependencies>
            </input-text>

            <!-- / Пользовательские проверки -->

        </fields>
    </form>
</simple-page>
