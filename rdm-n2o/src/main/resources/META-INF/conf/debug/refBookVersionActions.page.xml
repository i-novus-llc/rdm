<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-3.0" name="Реестр НСИ">
    <regions>
        <form id="version_select" query-id="refBookVersion">
            <pre-filters>
                <eq field-id="refBookId" param="refBookId"/>
            </pre-filters>

            <fields>
                <!-- Поля для передачи динамичных атрибутов из versionList при редактировании записи -->
                <!-- NB: Used as master-field-id="id" in depends-on="version_select" ? -->
                <row>
                    <output-text id="id">
                        <dependencies>
                            <set-value on="version">version.id</set-value>
                        </dependencies>
                    </output-text>

                    <output-text id="optLockValue">
                        <dependencies>
                            <set-value on="version">version.optLockValue</set-value>
                        </dependencies>
                    </output-text>

                    <output-text id="now"/>
                </row>

                <row>
                    <select id="version" label="Версия" cleanable="false"
                            query-id="versionList" label-field-id="version">
                        <pre-filters>
                            <eq field-id="refBookId" value="{refBookId}"/>
                        </pre-filters>

                        <!-- NB: Реализовать единую точку перехода в режим редактирования -->
                        <validations>
                            <condition id="refBookHasDraft" severity="warning"
                                       message="Справочник содержит неопубликованную версию">
                                (draftVersionId == null || version.id == draftVersionId)
                            </condition>
                            <condition id="isNotLastPublished" severity="warning"
                                       message="Выбранная версия справочника не является последней опубликованной версией">
                                (version.id == draftVersionId || version.id == lastPublishedVersionId)
                            </condition>
                        </validations>
                    </select>

                    <select id="localeCode" no-label="true" depends-on="version_select"
                            query-id="versionLocaleList" label-field-id="name">
                        <pre-filters>
                            <eq field-id="versionId" value="{version.id}"/>
                        </pre-filters>

                        <dependencies>
                            <visibility>return ${rdm.l10n.support}</visibility>
                            <set-value on="version">version.localeCode.id</set-value>
                        </dependencies>
                    </select>
                </row>
            </fields>

            <toolbar place="bottomLeft">
                <sub-menu label="Действия">
                    <menu-item label="Опубликовать"
                               visibility-condition="version.status=='DRAFT' &amp;&amp; !version.hasConflict">
                        <show-modal page-id="publish" upload="defaults">
                            <query-param name="versionId" value="{version.id}"/>
                            <query-param name="optLockValue" value="{optLockValue}"/>
                        </show-modal>
                    </menu-item>

                    <menu-item label="Обновить ссылки"
                               visibility-condition="version.isLast &amp;&amp; version.hasRefreshedConflict">
                        <invoke operation-id="refreshReferrer"/>
                    </menu-item>

                    <menu-item label="Загрузить из файла">
                        <show-modal page-id="uploadFile" submit-operation-id="uploadFromFile" upload="defaults"
                                    redirect-target="application"
                                    redirect-url-after-submit="${rdm.context-path}/main/:refBookId/edit">
                            <query-param name="versionId" value="{version.id}"/>
                        </show-modal>
                    </menu-item>

                    <menu-item label="Скачать">
                        <show-modal page-id="downloadFile" upload="defaults">
                            <query-param name="versionId" value="{version.id}"/>
                        </show-modal>
                    </menu-item>
                </sub-menu>
            </toolbar>
        </form>
    </regions>
</page>