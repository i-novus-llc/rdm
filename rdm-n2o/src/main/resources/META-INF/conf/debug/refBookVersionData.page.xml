<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-3.0" name="Реестр НСИ">
    <regions>
        <form id="version_select" query-id="refBookVersion">
            <pre-filters>
                <eq field-id="refBookId" param="refBookId"/>
            </pre-filters>

            <fields>
                <!-- Поля для передачи динамичных атрибутов из versionList при редактировании записи -->
                <!-- NB: Used as master-field-id="id" in depends-on="version_select" ? -->
                <row>
                    <output-text id="id">
                        <dependencies>
                            <set-value on="version">version.id</set-value>
                        </dependencies>
                    </output-text>

                    <output-text id="optLockValue">
                        <dependencies>
                            <set-value on="version">version.optLockValue</set-value>
                        </dependencies>
                    </output-text>

                    <output-text id="now"/>
                </row>

                <row>
                    <select id="version" label="Версия" cleanable="false"
                            query-id="versionList" label-field-id="version">
                        <pre-filters>
                            <eq field-id="refBookId" value="{refBookId}"/>
                        </pre-filters>

                        <!-- NB: Реализовать единую точку перехода в режим редактирования -->
                        <validations>
                            <condition id="refBookHasDraft" severity="warning"
                                       message="Справочник содержит неопубликованную версию">
                                (draftVersionId == null || version.id == draftVersionId)
                            </condition>
                            <condition id="isNotLastPublished" severity="warning"
                                       message="Выбранная версия справочника не является последней опубликованной версией">
                                (version.id == draftVersionId || version.id == lastPublishedVersionId)
                            </condition>
                        </validations>
                    </select>
                </row>
            </fields>
        </form>

        <tabs>
            <tab name="Данные">
                <table src="DataGrid" id="dataTable"
                       query-id="data" depends-on="version_select" fetch-on-init="true"
                       master-field-id="id" detail-field-id="versionId" object-id="data">
                    <pre-filters>
                        <eq field-id="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                        <eq field-id="localeCode" value=""/>
                    </pre-filters>

                    <toolbar place="topRight">
                        <!--to-do: сделать отдельные кнопки без рефреша для редактирования черновика-->
                        <button id="createRecord_r" label="Добавить" icon="fa fa-plus"
                                widget-id="version_select" model="resolve"
                                enabling-condition="version.hasStructure">
                            <show-modal page-id="dataRecordPage?{id}_create" page-name="Добавление новой записи"
                                        upload="query" route="/create"
                                        submit-operation-id="create" submit-label="Сохранить"
                                        refresh-widget-id="version_select">
                                <query-param name="id" value="0"/>
                                <query-param name="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="dataAction" value="create"/>
                            </show-modal>
                        </button>

                        <button id="updateRecord_r" label="Изменить" icon="fa fa-pencil"
                                widget-id="version_select" model="resolve">
                            <show-modal page-id="dataRecordPage?{id}_update" page-name="Редактирование записи"
                                        upload="query" route="/update"
                                        submit-operation-id="update" submit-label="Изменить"
                                        refresh-widget-id="version_select">
                                <query-param name="id" value="{id}" ref-widget-id="dataTable" ref-model="resolve"/>
                                <query-param name="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="dataAction" value="update"/>
                            </show-modal>
                        </button>

                        <button id="deleteRecord_r" label="Удалить" color="danger" icon="fa fa-trash">
                            <invoke operation-id="deleteRecord" refresh-widget-id="version_select" route="/delete"/>
                        </button>

                        <button id="deleteAllRecords_r" label="Удалить все" color="danger" icon="fa fa-trash">
                            <show-modal page-id="dataDeleteAll" upload="query" route="/deleteAll"
                                        submit-operation-id="deleteAllRecords" refresh-widget-id="version_select">
                                <pre-filters>
                                    <eq field-id="versionId" value="{version.id}" ref-widget-id="version_select" ref-model="resolve"/>
                                    <eq field-id="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                                </pre-filters>
                            </show-modal>
                        </button>

                        <button id="uploadData_r" label="Загрузить данные"
                                widget-id="version_select" model="resolve"
                                visibility-condition="version.status=='DRAFT'">
                            <show-modal page-id="uploadData" upload="defaults"
                                        submit-operation-id="uploadData" refresh-widget-id="version_select">
                                <pre-filters>
                                    <eq field-id="versionId" value="{version.id}"/>
                                </pre-filters>
                            </show-modal>
                        </button>
                    </toolbar>
                </table>
            </tab>
        </tabs>
    </regions>
</page>