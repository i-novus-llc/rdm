<?xml version='1.0' encoding='UTF-8'?>
<page xmlns="http://n2oapp.net/framework/config/schema/page-3.0" name="Реестр НСИ">
    <regions>
        <form id="version_select" query-id="refBookVersion">

            <pre-filters>
                <eq field-id="refBookId" param="refBookId"/>
            </pre-filters>

            <fields>
                <!-- Поля для передачи динамичных атрибутов из versionList при редактировании записи -->
                <!-- NB: Used as master-field-id="id" in depends-on="version_select" ? -->
                <set field-label-location="left">
                    <row>
                        <output-text id="id">
                            <dependencies>
                                <set-value on="version">version.id</set-value>
                            </dependencies>
                        </output-text>

                        <output-text id="optLockValue">
                            <dependencies>
                                <set-value on="version">version.optLockValue</set-value>
                            </dependencies>
                        </output-text>

                        <output-text id="now"/>
                    </row>
                </set>

                <select id="version" label="Версия" cleanable="false"
                        query-id="versionList" label-field-id="version">
                    <pre-filters>
                        <eq field-id="refBookId" value="{refBookId}"/>
                    </pre-filters>

                    <!-- NB: Реализовать единую точку перехода в режим редактирования -->
                    <validations>
                        <condition id="refBookHasDraft" severity="warning"
                                   message="Справочник содержит неопубликованную версию">
                            (draftVersionId == null || version.id == draftVersionId)
                        </condition>
                        <condition id="isNotLastPublished" severity="warning"
                                   message="Выбранная версия справочника не является последней опубликованной версией">
                            (version.id == draftVersionId || version.id == lastPublishedVersionId)
                        </condition>
                    </validations>
                </select>
            </fields>
        </form>

        <!--<tabs>-->
        <!--    <tab name="Структура">-->
                <table id="structure_table" ref-id="structure"
                       upload="query" depends-on="version_select" fetch-on-init="true"
                       master-field-id="id" detail-field-id="versionId">
                    <toolbar place="bottomRight">
                        <button label="Добавить" id="createAttribute_r"
                                widget-id="version_select" model="resolve">
                            <show-modal page-id="attribute" upload="defaults"
                                        submit-operation-id="createAttribute" refresh-widget-id="version_select">
                                <query-param name="versionId" value="{version.id}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                            </show-modal>
                        </button>
                        <button label="Изменить" id="editAttribute_r">
                            <show-modal page-id="attribute" submit-model="resolve"
                                        submit-operation-id="updateAttribute" refresh-widget-id="version_select">
                                <query-param name="versionId" value="{version.id}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="code" value="{code}"/>
                            </show-modal>
                        </button>
                        <button label="Удалить" id="deleteAttribute_r" color="danger" icon="fa fa-trash"
                                enabling-condition="!(isPrimary &amp;&amp; (isReferrer || hasReferrer))">
                            <invoke operation-id="deleteAttribute" close-after-success="false" refresh-widget-id="version_select"/>
                        </button>
                        <button label="Окно-заглушка" id="noModalOperation_r">
                            <show-modal page-id="attribute" submit-model="resolve"
                                        submit-operation-id="noOperation" refresh-widget-id="version_select">
                                <query-param name="versionId" value="{version.id}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="optLockValue" value="{optLockValue}" ref-widget-id="version_select" ref-model="resolve"/>
                                <query-param name="code" value="{code}" ref-widget-id="structure_table" ref-model="resolve"/>
                            </show-modal>
                        </button>
                        <button label="Действие-заглушка" id="noInvokeOperation_r">
                            <invoke operation-id="noOperation" close-after-success="false" refresh-widget-id="version_select"/>
                        </button>
                    </toolbar>
                </table>
        <!--    </tab>-->
        <!--</tabs>-->
    </regions>
</page>