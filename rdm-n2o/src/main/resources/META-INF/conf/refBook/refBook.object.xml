<?xml version='1.0' encoding='UTF-8'?>
<object xmlns="http://n2oapp.net/framework/config/schema/object-3.0" name="Справочник">

    <operations>
        <operation id="create" submit-label="Сохранить" success-text="Справочник успешно сохранен">
            <invocation>
                <rest method="POST">/refBook</rest>
            </invocation>

            <in-parameters>
                <param id="code" mapping="code" domain="string" mapper="spel"/>
                <param id="category.id" mapping="category" domain="string" mapper="spel"/>
                <param id="name" mapping="passport.name" domain="string" mapper="spel"/>
                <param id="shortName" mapping="passport.shortName" domain="string" mapper="spel"/>
                <param id="description" mapping="passport.description" domain="string" mapper="spel"/>
            </in-parameters>

            <out-parameters>
                <param id="refBookId" mapping="['refBookId']" domain="integer"/>
            </out-parameters>

        </operation>

        <operation id="edit" submit-label="Изменить" success-text="Справочник успешно изменен">
            <invocation>
                <java method="editPassport" class="ru.inovus.ms.rdm.service.CreateDraftController">
                    <spring/>
                    <arguments>
                        <argument type="primitive" name="versionId" class="java.lang.Integer"/>
                        <argument type="class" name="uiPassport" class="ru.inovus.ms.rdm.model.UiPassport"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="version.id" mapping="[0]" domain="integer" mapper="spel"/>
                <param id="code" mapping="[1].code" domain="string" mapper="spel"/>
                <param id="category.id" mapping="[1].category" domain="string" mapper="spel"/>
                <param id="name" mapping="[1].name" domain="string" mapper="spel"/>
                <param id="shortName" mapping="[1].shortName" domain="string" mapper="spel"/>
                <param id="description" mapping="[1].description" domain="string" mapper="spel"/>
            </in-parameters>
            <out-parameters>
                <param id="id" mapping="id" domain="integer"/>
            </out-parameters>
        </operation>

        <!-- WARN: confirm + confirm-text должен заработать после NNO-3132 -->
        <operation id="delete" submit-label="Удалить" success-text="Справочник удален"
                   confirm="true" confirm-text="Вы уверены, что хотите удалить этот справочник?">
            <invocation>
                <rest method="DELETE">/refBook?refBookId={refBookId}</rest>
            </invocation>
            <in-parameters>
                <param id="refBookId" mapping="refBookId" domain="integer" mapper="spel"/>
            </in-parameters>
        </operation>

        <operation id="publish" submit-label="Опубликовать" success-text="Справочник опубликован"
                   confirm="true" confirm-text="Вы уверены, что хотите опубликовать этот справочник?">
            <invocation>
                <java class="ru.inovus.ms.rdm.service.RefBookVersionController"
                      method="publishDraft">
                    <spring/>
                    <arguments>
                        <argument type="primitive" name="draftId" class="java.lang.Integer"/>
                        <argument type="primitive" name="processResolvableConflicts" class="java.lang.Boolean"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="version.id" mapping="[0]" domain="integer" mapper="spel"/>
                <param id="processResolvableConflicts" mapping="[1]" default-value="false" domain="boolean"/>
            </in-parameters>
            <validations white-list="checkDeletedConflicts,checkUpdatedConflicts"/>
        </operation>

        <operation id="refreshReferrer" submit-label="Обновить ссылки" success-text="Обновлены ссылки по первичным ключам"
                   confirm="true" confirm-text="Вы уверены, что хотите обновить ссылки?">
            <invocation>
                <java class="ru.inovus.ms.rdm.service.RefBookVersionController"
                      method="refreshReferrer">
                    <spring/>
                    <arguments>
                        <argument type="primitive" name="versionId" class="java.lang.Integer"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="version.id" mapping="[0]" domain="integer" mapper="spel"/>
            </in-parameters>
        </operation>

        <operation id="createFromFile" submit-label="Создать из файла" success-text="Справочник успешно сохранен">
            <invocation>
                <java class="ru.inovus.ms.rdm.service.CreateDraftController"
                      method="createFromFile">
                    <spring/>
                    <arguments>
                        <argument type="class" name="fileModel" class="ru.inovus.ms.rdm.model.FileModel"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="file.path" mapping="[0].path" domain="string"/>
                <param id="file.name" mapping="[0].name" domain="string"/>
            </in-parameters>
            <out-parameters>
                <param id="refBookId" mapping="['refBookId']" domain="integer"/>
            </out-parameters>
        </operation>

        <operation id="uploadFromFile" submit-label="Загрузить из файла" success-text="Файл загружен"
                   confirm="true" confirm-text="Вы уверены, что хотите загрузить справочник?">
            <invocation>
                <java class="ru.inovus.ms.rdm.service.CreateDraftController"
                      method="uploadFromFile">
                    <spring/>
                    <arguments>
                        <argument type="primitive" name="versionId" class="java.lang.Integer"/>
                        <argument type="class" name="fileModel" class="ru.inovus.ms.rdm.model.FileModel"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="versionId" mapping="[0]" domain="integer"/>
                <param id="file.path" mapping="[1].path" domain="string"/>
                <param id="file.name" mapping="[1].name" domain="string"/>
            </in-parameters>
            <out-parameters>
                <param id="refBookId" mapping="refBookId" domain="integer"/>
            </out-parameters>
        </operation>

        <operation id="uploadData" submit-label="Загрузить данные" success-text="Данные загружены">
            <invocation>
                <java class="ru.inovus.ms.rdm.service.CreateDraftController"
                      method="uploadData">
                    <spring/>
                    <arguments>
                        <argument type="primitive" name="versionId" class="java.lang.Integer"/>
                        <argument type="class" name="fileModel" class="ru.inovus.ms.rdm.model.FileModel"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="versionId" mapping="[0]" domain="integer"/>
                <param id="file.path" mapping="[1].path" domain="string"/>
                <param id="file.name" mapping="[1].name" domain="string"/>
            </in-parameters>
            <out-parameters>
                <param id="refBookId" mapping="refBookId" domain="integer"/>
            </out-parameters>
        </operation>

        <operation id="toArchive" submit-label="Отправить в архив" success-text="Справочник отправлен в архив"
                   confirm="true" confirm-text="Вы уверены, что хотите отправить этот справочник в архив?">
            <invocation>
                <rest method="POST">/refBook/{refBookId}/toArchive</rest>
            </invocation>
            <in-parameters>
                <param id="refBookId" mapping="refBookId" domain="integer" mapper="spel"/>
            </in-parameters>
        </operation>

        <operation id="fromArchive" submit-label="Вернуть из архива" success-text="Справочник возвращён из архива"
                   confirm="true" confirm-text="Вы уверены, что хотите вернуть этот справочник из архива?">
            <invocation>
                <rest method="POST">/refBook/{refBookId}/fromArchive</rest>
            </invocation>
            <in-parameters>
                <param id="refBookId" mapping="refBookId" domain="integer" mapper="spel"/>
            </in-parameters>
        </operation>

    </operations>

    <validations>
        <constraint id="checkDeletedConflicts" severity="warning" client-moment="before-load"
                    result="#this.length() == 0"
                    message="Были удалены строки, на которые ссылались справочники системы: {referrerNames}">
            <!--    NB: Реализовать как модальное окно перед операцией // NNO-1644 -->
            <!--                    "Продолжить публикацию?"-->
            <invocation>
                <java method="getCheckConflictReferrerNames" class="ru.inovus.ms.rdm.service.ConflictController">
                    <spring/>
                    <arguments>
                        <argument name="versionId" type="primitive" class="java.lang.Integer"/>
                        <argument name="conflictType" type="class"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="version.id" mapping="[0]" domain="integer"/>
                <param id="conflictType" default-value="DELETED" normalize="T(ru.inovus.ms.rdm.enumeration.ConflictType).valueOf(#this)"/>
            </in-parameters>
            <out-parameters>
                <param id="referrerNames" domain="string" mapping="#this"/>
            </out-parameters>
        </constraint>

        <constraint id="checkUpdatedConflicts" severity="warning" client-moment="before-load"
                    result="#this.length() == 0"
                    message="Были изменены строки, на которые ссылались справочники системы: {referrerNames}">
            <!--    NB: Реализовать как модальное окно перед операцией // NNO-1644 -->
<!--                    "Продолжить публикацию и обновить ссылки в связанных справочниках?"-->
            <invocation>
                <java method="getCheckConflictReferrerNames" class="ru.inovus.ms.rdm.service.ConflictController">
                    <spring/>
                    <arguments>
                        <argument name="versionId" type="primitive" class="java.lang.Integer"/>
                        <argument name="conflictType" type="class"/>
                    </arguments>
                </java>
            </invocation>
            <in-parameters>
                <param id="version.id" mapping="[0]" domain="integer"/>
                <param id="conflictType" default-value="UPDATED" normalize="T(ru.inovus.ms.rdm.enumeration.ConflictType).valueOf(#this)"/>
            </in-parameters>
            <out-parameters>
                <param id="referrerNames" domain="string" mapping="#this"/>
            </out-parameters>
        </constraint>

    </validations>
</object>